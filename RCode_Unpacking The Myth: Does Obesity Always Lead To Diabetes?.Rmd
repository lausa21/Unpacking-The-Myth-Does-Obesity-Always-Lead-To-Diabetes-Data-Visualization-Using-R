---
title: "Does Obesity Always Lead to Diabetes?"
author: "Kelompok 2"
date: "2024-05-26"
output: html_document
---

```{r setup, include=FALSE}
#knitr::opts_chunk$set(echo = TRUE)
#install.packages("reshape2")
#install.packages("shiny")
#install.packages("plotrix")
#install.packages("webshot")
#webshot::install_phantomjs()
```

# Add Library

```{r}
library(dplyr)
library(tidyverse)
library(ggplot2)
library(plotly)
library(shiny)
library(reshape2)
library(plotrix)
library(webshot)
```

# Import Dataset

```{r}
dat <- read.csv("diabetes.csv", header = TRUE)
dat
```

# Check missing values

```{r}
colSums(is.na(dat))
```

# Show the structure of the data

```{r}
str(dat)
```


# Copy of Dataset

```{r}
cleaned_dat <- dat
cleaned_dat
```

# Clean Dataset

```{r}
# Fix the integer variables that are unlikely to be worth 0 (blood pressure, insulin level, BMI, skin thickness, and glucose level)
data_bloodPressure <- dat %>%
  filter(BloodPressure != 0)

data_insulin <- dat %>%
  filter(Insulin != 0)

data_BMI <- dat %>%
  filter(BMI != 0)

data_skinThickness <- dat %>%
  filter(SkinThickness != 0)

data_glucose <- dat %>%
  filter(Glucose != 0)

# Replace the 0 value with median value of the data
cleaned_dat <- dat %>%
  mutate(
    BloodPressure = ifelse(BloodPressure == 0, median(data_bloodPressure$BloodPressure, na.rm = TRUE), BloodPressure),
    Insulin = ifelse(Insulin == 0, median(data_insulin$Insulin, na.rm = TRUE), Insulin),
    BMI = ifelse(BMI == 0, median(data_BMI$BMI, na.rm = TRUE), BMI),
    SkinThickness = ifelse(SkinThickness == 0, median(data_skinThickness$SkinThickness, na.rm = TRUE), SkinThickness),
    Glucose = ifelse(Glucose == 0, median(data_glucose$Glucose, na.rm = TRUE), Glucose),
  )

cleaned_dat
```

# New Attributes

```{r}
# Make 3 new attributes called Age_Category, BMI_Category, and Outcome_Category
cleaned_dat <- cleaned_dat %>%
  mutate(
    Age_Category = case_when(
      Age > 20 & Age <= 35 ~ "20-35",
      Age > 35 & Age <= 50 ~ "36-50",
      Age > 50 & Age <= 65 ~ "51-65",
      Age > 65 ~ ">65"
    ),
    BMI_Category = case_when(
      BMI < 18.5 ~ "Underweight",
      BMI >= 18.5 & BMI < 24.9 ~ "Normal Weight",
      BMI >= 24.9 & BMI < 29.9 ~ "OverWeight",
      BMI >= 29.9 ~ "Obese"
    ),
    Outcome_Category = case_when(
      Outcome == 1 ~ "Diabetic",
      Outcome == 0 ~ "Non-Diabetic"
    )
  )
cleaned_dat

# Recheck the missing values
colSums(is.na(cleaned_dat))
```

# Summary & table to explore what insights can be gained

```{r}
summary(cleaned_dat$Glucose)
summary(cleaned_dat$BloodPressure)
summary(cleaned_dat$SkinThickness)
summary(cleaned_dat$Insulin)
summary(cleaned_dat$BMI)
summary(cleaned_dat$DiabetesPedigreeFunction)
summary(cleaned_dat$Age)

table(cleaned_dat$Age_Category)
table(cleaned_dat$BMI_Category)
```

# 1. Column Chart: Worldwide Death Cause
```{r}
# Create the data frame
DeathRate_Causes <- data.frame(
  Causes = c("Cardiovascular diseases", "Cancer", "Hypertension", "Air pollution", "Chronic obstructive respiratory diseases", "Alcohol", "Pneumonia", "Diabetes", "Tuberculosis", "Road traffic accidents"),
  Deaths = c(17900000, 9600000, 7500000, 7000000, 3170000, 3000000, 2560000, 1600000, 1500000, 1350000)
)

# Sort the data frame by Deaths in descending order
DeathRate_Causes_Sort <- DeathRate_Causes[order(DeathRate_Causes$Deaths, decreasing = TRUE),]
DeathRate_Causes_Sort

# Make the column chart
ggplot(DeathRate_Causes_Sort, aes(y = reorder(Causes, Deaths), x = Deaths, fill = as.factor(Causes))) +
  geom_col(position = "dodge", color = "black", width = 0.7) +
  labs(title = "Death Rates by Causes",
       x = "Number of Deaths",
       y = "Causes") +
  scale_fill_manual(
    values = c(
      "Cardiovascular diseases" = "#C4C4C3",
      "Cancer" = "#C4C4C3",
      "Hypertension" = "#C4C4C3",
      "Air pollution" = "#C4C4C3",
      "Chronic obstructive respiratory diseases" = "#C4C4C3",
      "Alcohol" = "#C4C4C3",
      "Pneumonia" = "#C4C4C3",
      "Diabetes" = "#E16463",
      "Tuberculosis" = "#C4C4C3",
      "Road traffic accidents" = "#C4C4C3"
    )
  ) +
  theme(
    panel.background = element_rect(fill = "white"),
    legend.position = "none"
  )
```

# 2. Bar Chart (for shiny only): BMI Distribution 
```{r}
# Count the total row in the dataset
total = nrow(cleaned_dat)

# Create a new table called bmi_dist to store the amount in each BMI category 
bmi_dist <- cleaned_dat %>% 
  group_by(BMI_Category) %>% 
  summarise(
    count_bmi = n()
  )

# To count the percentage of each BMI category
bmi_dist <- bmi_dist %>% 
  mutate(
    Percentage = round(count_bmi / total * 100, 2)
  )

bmi_dist

# Create the chart
ggplot(bmi_dist, aes(x = BMI_Category, y = Percentage, fill = BMI_Category))+
  geom_col()+
  labs(title = "BMI Distribution for Pima Indian  Women",
       x = "BMI Category",
       y = "Percentage")+
  theme_minimal()+
  scale_fill_manual(
    values = c(
      "Obese" = "#F0A829",
      "Normal Weight" =  "#F8DFB2",
      "OverWeight" =  "#F8DFB2",
      "UnderWeight" =  "#F8DFB2"
    )
  )
```
# 3. Pie Chart (for infographic only): BMI Distribution

```{r}
total_data <- sum(cleaned_dat$BMI)

# Create a new table for calculate percentage for BMI category
summary_BMI <- cleaned_dat %>%
  group_by(BMI_Category) %>%
  summarise(
    Total = n(),
    Percentage = Total / total_data * 100,
    .groups = 'drop'
  )
summary_BMI

colors_BMI <- c("#004789","#FFC952", "#8DC1F1","#2E83D1")

plot_ly(data = summary_BMI, 
        type = 'pie', 
        values = ~Percentage, 
        labels = ~BMI_Category, 
        marker = list(colors = colors_BMI),
        textinfo = 'label+percent')

```

# 4. Pie chart (for infographic only): Percentage of Diabetic and Non-diabetic in Obese Population

```{r}
# Count the total obese people from the data
total_obese <- nrow(filter(cleaned_dat, BMI_Category == "Obese"))

# creat a new table containing percentage comparisons between diabetic and non diabetic in obese population
tbl_obese <- cleaned_dat %>% 
  filter(BMI_Category == "Obese") %>% 
  group_by(Outcome_Category) %>% 
  summarise(
    count_outcome = n(),
    .groups = "drop"
  ) %>% 
  mutate(
    Percentage = round(count_outcome / total_obese * 100, 2)
  )
tbl_obese

colors <- c("#75B1E8","#E16463")

plot_ly(data = tbl_obese, 
        type = 'pie', 
        values = ~Percentage, 
        labels = ~Outcome_Category,
        marker = list(colors = c("#E16463", "#75B1E8")),
        textinfo = 'label+percent')
```

# 5. Doughnut chart (for shiny only): Percentage of Diabetic and Non-diabetic in Obese Population
```{r}
# Count the total obese people from the data
total_obese <- nrow(filter(cleaned_dat, BMI_Category == "Obese"))

# creat a new table containing percentage comparisons between diabetic and non diabetic in obese population
obesepop <- cleaned_dat %>% 
  filter(BMI_Category == "Obese") %>% 
  group_by(Outcome_Category) %>% 
  summarise(
    count_outcome = n(),
    .groups = "drop"
  ) %>% 
  mutate(
    percent = round(count_outcome / total_obese * 100, 2)
  )
obesepop

# Create the pie chart
plot_ly(data = obesepop, 
        type = 'pie', 
        values = ~percent, 
        labels = ~Outcome_Category, 
        textinfo = 'label+percent',
        hole = 0.4) %>%
  layout(title = "Pie Chart of Obesity Diabetic Status")
```

# 6. Heatmap (for shiny only): Correlation Between All Diabetes Factor Variables in Obese Population

```{r}
# Filter the dataset to be specific to obese population
cleaned_dat2 <- cleaned_dat %>% 
  filter(BMI_Category == "Obese")

# Count the correlation matrix
correlation_matrix <- cor(cleaned_dat2[, c("SkinThickness", "BloodPressure", "Insulin", "BMI", "Pregnancies", "DiabetesPedigreeFunction", "Age", "Outcome")])
correlation_matrix

# Sort the diabetes factor variables based on their correlation with outcomes in descending order
ordered_vars <- names(sort(correlation_matrix["Outcome",], decreasing = TRUE))
ordered_vars

# Sort the correlation matrix by the order of the variables
ordered_correlation_matrix <- correlation_matrix[ordered_vars, ordered_vars]
ordered_correlation_matrix

# Create a correlation heatmap with a pre-set order
ggplot(data = melt(ordered_correlation_matrix), aes(Var1, Var2, fill = value)) +
  geom_tile() +
  labs(x = "Diabetes Factors", y = "Diabetes Factors", fill = "Correlation") +
  scale_fill_gradient(low = "#FFF3DD", high = "#F0A829") +
   theme(
    axis.text.x = element_text(angle = 20, hjust = 1),
    panel.background = element_rect(fill = "white")
  )
```

# 7. Stacked Bar Chart: Percentage of Diabetic and Non-Diabetic Based On Age Category

```{r}
# Define the custom order
customOrder = c("20-35", "36-50", "51-65", ">65")

# Process the data
summary_age_category <- cleaned_dat %>%
  filter(BMI_Category == "Obese") %>%
  mutate(
    Broader_Age_Category = substr(Age_Category, 1, 1)
  ) %>%
  group_by(Broader_Age_Category) %>%
  mutate(
    Broader_Total = n()
  ) %>%
  group_by(Age_Category, Outcome, Broader_Age_Category, Broader_Total) %>%
  summarise(
    Total = n(),
    .groups = 'drop'
  ) %>%
  mutate(
    Percentage = round(Total / Broader_Total * 100, 2),
    Age_Category = factor(Age_Category, levels = customOrder),
    Outcome = factor(Outcome, levels = c(1, 0), labels = c("Diabetic","Non-Diabetic")),
    Combined = interaction(Age_Category, Outcome, sep = " ")
  ) %>%
  select(-Broader_Age_Category)

summary_age_category

# Create the chart
ggplot(summary_age_category, aes(x = Age_Category, y = Percentage, fill = Combined)) +
  geom_col() +
  labs(fill = "Diabetic Status", x = "Age Categories", y = "Percentage", title = "Percentage of Diabetic and Non-Diabetic Based On Age Category") +
  scale_fill_manual(values = c(
    "20-35 Diabetic" = "#C4C4C3", "20-35 Non-Diabetic" = "#F4F3F3",
    "36-50 Diabetic" = "#C4C4C3", "36-50 Non-Diabetic" = "#F4F3F3",
    "51-65 Diabetic" = "#F0A829", "51-65 Non-Diabetic" = "#F8DFB2",
    ">65 Diabetic" = "#F0A829", ">65 Non-Diabetic" = "#F8DFB2"
  )) +
  theme(
    panel.background = element_rect(fill = "white"),
    axis.line = element_line(color = "black")
  )

```

# 8. Grouped bar chart : Percentage of Diabetic and Non diabetic Based on BMI Category and Genetic Function Index

```{r}
# Summarize the data
summary_ped_BMI <- cleaned_dat %>%
  group_by(BMI_Category, Outcome_Category) %>%
  summarise(
    Average = round(mean(DiabetesPedigreeFunction), 2),
    .groups = 'drop'
  )

# Define the custom order for BMI categories
custom_bmi_order <- c("Underweight", "Normal Weight", "OverWeight", "Obese")

# Convert BMI_Category to a factor with the custom order
summary_ped_BMI$BMI_Category <- factor(summary_ped_BMI$BMI_Category, levels = custom_bmi_order)

# Create a new variable for combining BMI_Category and Outcome
summary_ped_BMI$Combined <- interaction(summary_ped_BMI$BMI_Category, summary_ped_BMI$Outcome_Category, sep = " ")
summary_ped_BMI

# Create the chart
ggplot(summary_ped_BMI, aes(x = BMI_Category, y = Average, fill = Combined)) +
  geom_col(position = "dodge", width = 0.7) +
  geom_text(aes(label = round(Average, 2)),  # Adding text on top of the bars
            position = position_dodge(width = 0.7), 
            vjust = -0.5) +
  labs(
    title = "Diabetic Percentage based on BMI Category and Genetic Factor Index", 
    x = "BMI Category", 
    y = "Average Genectic Factor Index", 
    fill = "Diabetic Status"
  ) +
  scale_fill_manual(
    values = c(
      "Obese Diabetic" = "#F0A829", "Obese Non-Diabetic" = "#F8DFB2",
      "OverWeight Diabetic" = "#C4C4C3", "OverWeight Non-Diabetic" = "#F4F3F3",
      "Normal Weight Diabetic" = "#C4C4C3", "Normal Weight Non-Diabetic" = "#F4F3F3",
      "Underweight Diabetic" = "#C4C4C3", "Underweight Non-Diabetic" = "#F4F3F3"
    )
  ) +
  theme(
    panel.background = element_rect(fill = "white"),
    axis.line = element_line(color = "black")
  )

```

# 9. Bar Chart: Average Pregnancies Number For Each Diabetic Status
```{r}
preg <- cleaned_dat %>% 
  filter(BMI_Category == "Obese") %>%
  group_by(Outcome_Category) %>% 
  summarise(
    average_pregnancy = round(mean(Pregnancies, na.rm = TRUE))
  )
preg

ggplot(preg, aes(x = Outcome_Category, y = average_pregnancy, fill = Outcome_Category))+
  geom_col()+
  labs(fill = "Diabetic Status", x = "Diabetic Status", y = "Average Pregnancies Count", title = "Average Pregnancies Number For Each Diabetic Status")+
  scale_fill_manual(values = c("Diabetic" = "#F0A829",
                               "Non-Diabetic" = "#F8DFB2"))+
  theme(
        panel.background = element_rect(fill = "white"),
    axis.line = element_line(color = "black")
  )
```
